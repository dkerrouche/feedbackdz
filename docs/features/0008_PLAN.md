# 0008 – User-owned Businesses (Auth-backed Dashboard)

Brief: Organize businesses by authenticated user. Remove phone-based selection and mock flows, enforce per-user ownership across DB, API, and UI. Dashboard must show only the current user's business, prompt first-time users to create one, and secure all data access via RLS and middleware.

## Scope
- Re-enable real auth (email-first and Google) and protect `/dashboard` and APIs.
- Bind `businesses` to the current Supabase user (`user_id = auth.uid()`).
- Replace phone-based lookups with session-based `user_id` queries.
- Enforce ownership in APIs and RLS; remove mock/bypass logic.

## Files To Update / Create
- `src/middleware.ts`: Re-enable protection; allow `/auth/callback`; block `/dashboard` and protected APIs without a session.
- `src/lib/auth.ts`: Ensure session retrieval (`getCurrentUser`) and `AuthUser` shape are used as the single source of truth.
- `src/app/page.tsx`: Show Sign In when unauthenticated; Go to Dashboard when authenticated.
- `src/app/dashboard/page.tsx`: Load business by `user_id` (from session), drop phone filter; show first-login create flow.
- `src/components/business/BusinessProfile.tsx`: Fetch/update business by `user_id`; on create, insert with `user_id = auth.uid()`.
- `src/components/survey/SurveyGenerator.tsx` (and related): Use passed `business.id`; do not infer by phone.
- `src/pages/api/surveys/index.ts` or `src/app/api/surveys/route.ts` (whichever exists): Validate that requested `business_id` belongs to `auth.uid()` before returning/mutating.
- `src/pages/api/responses/*` or `src/app/api/responses/*`: Same ownership validation.
- `database/add-user-management.sql`: Confirm `businesses.user_id` exists and RLS policies check `auth.uid()`.
- `src/types/index.ts`: Ensure `Business` includes `user_id?: string`; `AuthUser` already updated to `phone?`.

## Data Layer (Required First)
1) Schema
   - Ensure `businesses.user_id UUID NOT NULL` (or nullable during backfill then set NOT NULL later).
   - Add index on `businesses.user_id`.
   - Optional: unique `(user_id)` if 1 business per user is desired.

2) RLS (Row Level Security)
   - Enable RLS on `businesses`.
   - Policies:
     - SELECT: `using (user_id = auth.uid())`
     - INSERT: `with check (user_id = auth.uid())`
     - UPDATE/DELETE: `using (user_id = auth.uid())`
   - Mirror ownership checks for `surveys`, `responses`, and `ai_summaries` via `business_id` join to a business owned by `auth.uid()`.

3) Backfill (Dev-only)
   - For existing rows, set `user_id` to a known test user's `auth.uid()`.

## Middleware / Auth
1) `src/middleware.ts`
   - Allow `/auth/callback` and other public routes.
   - Require session for `/dashboard` and protected `/api/*` endpoints.

2) `src/lib/auth.ts`
   - `getCurrentUser()` returns `{ id, email?, phone?, created_at }` from session.
   - Remove residual dev-auth paths; rely on Supabase session and `onAuthStateChange`.

## API Ownership Enforcement
1) Surveys API
   - Read session from cookies and resolve `auth.uid()`.
   - On read: verify `business_id` belongs to `auth.uid()`.
   - On create/update/delete: same verification guard.

2) Responses API
   - Apply identical business ownership checks.

## Client Logic
1) `src/app/dashboard/page.tsx`
   - On mount: get session user via `useAuthContext()`.
   - Query: `select * from businesses where user_id = auth.uid() limit 1` using the session-bound client.
   - If none: render a first-login card with `BusinessProfile` create form.
   - If exists: set `business` and fetch surveys via API with `business.id`.

2) `src/components/business/BusinessProfile.tsx`
   - On create: insert business with `user_id = auth.uid()` (do not trust client-provided user_id).
   - Do not use phone for queries; rely on session.

3) `src/app/page.tsx`
   - If authenticated: show “Go to Dashboard”; else show “Sign In”.

## Algorithms / Flows
1) Dashboard init
   - `user = getSessionUser()`
   - If `!user`: redirect to `/` (middleware will also guard).
   - `business = select * from businesses where user_id = user.id limit 1`
   - If `!business`: show create flow.
   - Else: `GET /api/surveys?business_id=business.id` (server validates ownership) → render.

2) Create Business
   - Form submit → server insert `businesses` with `user_id = auth.uid()`
   - Return created row → set in state → continue dashboard load.

## Cleanup
- Delete phone-based lookups and mock OTP/localStorage gates.
- Reduce console logs for production builds.

## Validation Checklist
- Unauthed access to `/dashboard` is blocked.
- New authed user sees “Create Business”, successful insert binds to `auth.uid()`.
- Existing authed user sees only their business; APIs reject foreign `business_id`s.
- RLS prevents cross-user reads/writes, even if API checks are bypassed.


