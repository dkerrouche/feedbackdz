# Real-time Dashboard & Analytics Implementation

## Description
Implement real-time dashboard updates and comprehensive analytics for restaurant owners to track customer feedback, response trends, and business insights. This includes real-time response feeds, interactive charts, filtering capabilities, and response management features using Supabase Realtime subscriptions and data visualization.

## Files to Modify

### 1. Real-time Subscriptions
**Files:**
- `src/lib/supabase.ts` - Add real-time client configuration
- `src/hooks/useRealtimeResponses.ts` - Custom hook for real-time response updates
- `src/app/dashboard/page.tsx` - Integrate real-time subscriptions

**Changes:**
- Configure Supabase Realtime client for response subscriptions
- Create custom hook to subscribe to responses by business_id
- Update dashboard to show real-time response updates
- Handle connection states and error recovery

### 2. Analytics Data Layer
**Files:**
- `src/lib/analytics.ts` - Analytics calculation functions
- `src/app/api/analytics/route.ts` - Analytics API endpoint
- `src/types/index.ts` - Add analytics types

**Changes:**
- Create analytics calculation functions (ratings, sentiment, trends)
- Build API endpoint to fetch analytics data
- Add TypeScript interfaces for analytics data structures
- Implement data aggregation and filtering logic

### 3. Dashboard Components
**Files:**
- `src/components/dashboard/AnalyticsCards.tsx` - Real-time analytics cards
- `src/components/dashboard/ResponseFeed.tsx` - Real-time response feed
- `src/components/dashboard/Charts.tsx` - Interactive charts component
- `src/components/dashboard/ResponseFilters.tsx` - Filtering and search
- `src/app/dashboard/page.tsx` - Update overview tab with real components

**Changes:**
- Replace placeholder analytics cards with real data
- Create real-time response feed with transcription/sentiment display
- Add interactive charts for trends and sentiment analysis
- Implement filtering by date, rating, sentiment, and search
- Add response management features (mark as addressed, export)

### 4. Charts and Visualization
**Files:**
- `src/components/dashboard/charts/RatingChart.tsx` - Rating distribution chart
- `src/components/dashboard/charts/SentimentChart.tsx` - Sentiment analysis chart
- `src/components/dashboard/charts/TrendsChart.tsx` - Response trends over time
- `package.json` - Add Recharts dependency

**Changes:**
- Install and configure Recharts for data visualization
- Create rating distribution pie/bar chart
- Build sentiment analysis gauge and breakdown charts
- Implement response trends over time (daily/weekly/monthly)
- Add responsive chart designs for mobile/desktop

### 5. Response Management
**Files:**
- `src/components/dashboard/ResponseItem.tsx` - Individual response display
- `src/components/dashboard/ResponseActions.tsx` - Response action buttons
- `src/app/api/responses/[id]/route.ts` - Response update API
- `src/lib/export.ts` - CSV/PDF export functionality

**Changes:**
- Create individual response display with full details
- Add response actions (mark as addressed, flag, delete)
- Build API endpoint for response updates
- Implement CSV export for response data
- Add response search and filtering capabilities

## Algorithm

### Real-time Updates
1. Subscribe to responses table changes by business_id
2. Filter for INSERT operations to get new responses
3. Update local state with new response data
4. Trigger re-render of analytics cards and response feed
5. Handle connection drops and reconnection logic

### Analytics Calculations
1. Fetch responses for business within date range
2. Calculate total responses, average rating, sentiment breakdown
3. Group by time periods (daily/weekly/monthly) for trends
4. Extract keywords and generate insights
5. Cache results and update on new responses

### Data Flow
1. User opens dashboard → Load initial analytics data
2. Subscribe to real-time updates → New responses appear instantly
3. User applies filters → Recalculate analytics with filtered data
4. User exports data → Generate CSV with current filter state
5. User manages responses → Update response status via API

## Implementation Phases

### Phase 1: Real-time Infrastructure
- Setup Supabase Realtime client configuration
- Create useRealtimeResponses hook
- Integrate real-time subscriptions in dashboard
- Test real-time updates with sample data

### Phase 2: Analytics Data Layer
- Build analytics calculation functions
- Create analytics API endpoint
- Add TypeScript interfaces for analytics
- Implement data aggregation logic

### Phase 3: Dashboard Components
- Create AnalyticsCards component with real data
- Build ResponseFeed component for real-time updates
- Implement ResponseFilters for search and filtering
- Add ResponseItem and ResponseActions components

### Phase 4: Charts and Visualization
- Install and configure Recharts
- Create rating distribution charts
- Build sentiment analysis visualizations
- Implement trends charts over time
- Add responsive chart designs

### Phase 5: Response Management
- Create response update API endpoints
- Implement CSV export functionality
- Add response management actions
- Build search and advanced filtering

## Technical Details

### Real-time Subscription Structure
```typescript
interface RealtimeResponse {
  id: string
  survey_id: string
  business_id: string
  rating: number
  sentiment: string
  transcription: string
  created_at: string
  // ... other fields
}
```

### Analytics Data Structure
```typescript
interface AnalyticsData {
  totalResponses: number
  averageRating: number
  sentimentBreakdown: {
    positive: number
    neutral: number
    negative: number
  }
  trends: {
    date: string
    responses: number
    averageRating: number
  }[]
  recentResponses: RealtimeResponse[]
}
```

### Chart Components
- **RatingChart**: Pie chart showing 1-5 star distribution
- **SentimentChart**: Gauge showing positive/neutral/negative breakdown
- **TrendsChart**: Line chart showing responses over time
- **KeywordsChart**: Word cloud or bar chart of extracted keywords

### Filtering System
- **Date Range**: Last 7 days, 30 days, 90 days, custom range
- **Rating Filter**: 1-2 stars, 3 stars, 4-5 stars, all ratings
- **Sentiment Filter**: Positive, neutral, negative, all sentiments
- **Search**: Full-text search in transcriptions
- **Survey Filter**: Filter by specific survey QR codes

### Export Functionality
- **CSV Export**: All responses with current filters applied
- **PDF Export**: Analytics summary with charts (future)
- **Real-time Data**: Export includes latest data at time of export
- **Filtered Export**: Only export data matching current filter criteria
