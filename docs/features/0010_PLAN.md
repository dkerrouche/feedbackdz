## 0010 – Prioritized roadmap for pending features (auth deferred)

Brief
- Goal: Prioritize and plan remaining features from recent iterations, excluding authentication (will be handled later).
- Scope: Dashboard realtime analytics refresh, charts, combined server-backed filters/search, CSV export alignment, bulk actions, UX polish, performance.

Relevant context/files
- `src/app/dashboard/page.tsx`: owns fetching analytics, responses pagination, date range; wires `ResponseFeed`, `AnalyticsCards`, `DashboardCharts`.
- `src/components/dashboard/ResponseFeed.tsx`: client filters state, actions, export; now memoized and calls `onResponseMutated`.
- `src/components/dashboard/ResponseFilters.tsx`: filters UI; converted to combinable checkboxes.
- `src/components/dashboard/DashboardCharts.tsx` + `charts/*`: sentiment pie exists; add trends, rating distribution, keywords charts.
- `src/components/dashboard/ResponseDetailModal.tsx`: notes autosave on close/delete; actions.
- API: `src/app/api/analytics/route.ts`, `src/app/api/responses/route.ts`, `src/app/api/responses/export/route.ts`, `src/app/api/responses/[id]/route.ts`.
- Types/filters: `src/types/index.ts` (ResponseFilters, RealtimeResponse), `src/lib/response-filters.ts`.

Plan (phased, parallelizable)

Phase 1 – Data layer and server filtering
1) Extend analytics API to accept full filter set
   - File: `src/app/api/analytics/route.ts`
   - Read query params: ratings[], sentiments[], includeAudio/includeText, isFlagged, isAddressed, search, qrs, date range.
   - Apply Postgres filters using `in()` for ratings/sentiments, `or()` for audio/text, booleans for flags, ILIKE for search, `jsonb_exists_text` for keywords if needed.
   - Return same `AnalyticsData` shape; ensure counts reflect filters.
2) Extend responses list API to support new filters fully (server is already close)
   - File: `src/app/api/responses/route.ts`
   - Ensure all new params from UI exist: ratings (comma list), sentiments (comma list), includeAudio/includeText flags combined into an `or` for `audio_url is null/not null`.
   - Add optional `is_flagged`, `is_addressed` filters.
   - Confirm search covers transcription ILIKE AND keywords via `jsonb_exists_text`.
3) DB indexing for performance
   - Add composite indexes where helpful: `(business_id, created_at desc)`, `(business_id, rating)`, `(business_id, sentiment)`, `(business_id, is_flagged)`, `(business_id, is_addressed)`, and trigram index on transcription if enabled.
   - File: `database/schema.sql` (or new migration `database/indices_0010.sql`).

Phase 2 – Client: server-backed filters and URL state
1) Wire filters to server
   - Files: `src/app/dashboard/page.tsx`, `src/components/dashboard/ResponseFeed.tsx`, `src/components/dashboard/ResponseFilters.tsx`.
   - Replace client-only filtering for the list with server-backed fetch using the new params (keep client filter for instant UX but source of truth is server).
   - On filter change → reset page=1 and refetch responses and analytics in parallel.
2) Persist filters in URL
   - Use `useSearchParams` / `useRouter` to reflect filters (ratings, sentiments, audio/text, flags, addressed, search, qrs, date) in the querystring.
   - On page load, initialize filter state from URL.

Phase 3 – Realtime analytics refresh
1) Lightweight analytics invalidation
   - On `responses` INSERT/UPDATE/DELETE realtime events, trigger a throttled analytics refetch if current dashboard business/date range is active.
   - Files: `src/app/dashboard/page.tsx`, `src/hooks/useRealtimeResponses.ts` (emit callback), small throttle util.
2) Optional: push pre-aggregated metrics
   - Add a Postgres trigger/edge function to publish minimal deltas onto a realtime channel (optional stretch).

Phase 4 – Charts suite
1) Trends line chart
   - Add `responses per day` and `avg rating per day` over selected date range.
   - Files: `src/components/dashboard/DashboardCharts.tsx`, `charts/TrendsChart.tsx`.
2) Rating distribution bar chart
   - Show 1–5 counts.
   - Files: `charts/RatingDistributionChart.tsx`.
3) Keywords bar/word cloud
   - Use `analytics.keywordCounts` for top-N; implement horizontal bar or simple cloud.
   - Files: `charts/KeywordsChart.tsx`.

Phase 5 – Bulk actions and UX polish
1) Bulk select and actions
   - Add checkbox per row + header select-all, maintain `selectedIds` in `ResponseFeed`.
   - Actions: bulk flag/unflag, mark/unmark addressed, delete, export selected.
   - Files: `ResponseFeed.tsx`, `ResponseItem.tsx`, `lib/response-management.ts` (batch helpers exist).
2) Toasts and inline errors
   - Lightweight toast system or use a small library; success/error on actions, export, autosave.
   - Files: shared `components/ui/Toast.tsx` and hooks.
3) Virtualized list for performance (optional if needed)
   - Swap list to `react-virtual` or similar when count is large.

Phase 6 – CSV export parity
1) Ensure server export supports the same filter params as the list
   - File: `src/app/api/responses/export/route.ts`.
   - Add ratings/sentiments/includeAudio/includeText/is_flagged/is_addressed.
2) Client wires same filters when exporting.

Algorithms/logic notes
- Filter combination:
  - Ratings: `rating in (..)`
  - Sentiments: `sentiment in (..)`
  - Audio/Text: `(audio_url is not null AND includeAudio=true) OR (audio_url is null AND includeText=true)`; if both false → return 0 results.
  - Flags: `is_flagged = true` when selected; `is_addressed = true` when selected; null → ignore.
  - Search: `transcription ILIKE '%term%' OR jsonb_exists_text(keywords, 'term')` (wrap term normalization).
- Realtime analytics refresh: throttle (e.g., 1–2s) to avoid bursts; only when Overview tab is active and business matches.

Out of scope (explicitly deferred)
- Authentication flows (Supabase OTP, sessions) – will implement later per instruction.
- Admin panel and emails – can follow after above phases.

Acceptance checkpoints (per phase)
- Phase 1: APIs accept all filters; responses and analytics match counts under combined filters.
- Phase 2: Filters are URL-driven; refreshes are consistent and debounced.
- Phase 3: Analytics refresh within ~2s of response updates without jitter.
- Phase 4: Charts render correctly for selected date range.
- Phase 5: Bulk actions operate correctly with toasts; list remains performant.
- Phase 6: Export CSV mirrors list filters 1:1.


