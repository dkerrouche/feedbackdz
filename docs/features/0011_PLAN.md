# 0011 â€“ Enhanced Server-Side Filtering and Analytics API

## Brief
Implement comprehensive server-side filtering for both analytics and responses APIs to support the full dashboard filter UI. This includes extending query parameter support, optimizing database queries with proper indexing, and ensuring consistent filter behavior across all endpoints.

## Context
The current implementation has basic filtering in place but needs enhancement to support the complete filter set planned for the dashboard UI. The analytics API currently accepts limited filters, and the responses API needs alignment with the new filter requirements from the dashboard redesign.

## Files to Modify

### API Routes
- `src/app/api/analytics/route.ts`
  - Extend to accept full filter parameter set: ratings[], sentiments[], includeAudio, includeText, isFlagged, isAddressed, search, qrs
  - Apply Postgres filters using `in()` for arrays, `or()` for audio/text conditions, boolean filters for flags
  - Ensure returned `AnalyticsData` counts reflect applied filters
  - Add search support using `ilike` for transcription and `jsonb_exists_text` for keywords

- `src/app/api/responses/route.ts`
  - Add missing filter parameters: includeAudio, includeText flags combined into audio_url null/not null conditions
  - Add `is_flagged` and `is_addressed` boolean filters
  - Enhance search to cover both transcription ILIKE and keywords via `jsonb_exists_text`
  - Ensure all new parameters are properly validated and applied

### Database Schema
- `database/schema.sql` or new `database/indices_0011.sql`
  - Add composite indexes for performance:
    - `(business_id, created_at DESC)` - already exists, verify
    - `(business_id, rating)` - for rating filters
    - `(business_id, sentiment)` - for sentiment filters  
    - `(business_id, is_flagged)` - for flagged responses
    - `(business_id, is_addressed)` - for addressed responses
  - Consider trigram index on transcription for full-text search if needed

### Type Definitions
- `src/types/index.ts`
  - Ensure `ResponseFilters` interface includes all new filter fields
  - Add any missing types for the enhanced API parameters

## Implementation Details

### Analytics API Enhancement
The analytics endpoint needs to accept and apply these query parameters:
- `ratings` (comma-separated): `1,2,3,4,5`
- `sentiments` (comma-separated): `positive,neutral,negative`
- `includeAudio` (boolean): filter for responses with audio
- `includeText` (boolean): filter for responses with text only
- `isFlagged` (boolean): filter for flagged responses
- `isAddressed` (boolean): filter for addressed responses
- `search` (string): search in transcription and keywords
- `qrs` (comma-separated): filter by specific QR codes

### Filter Logic Algorithm
1. **Ratings filter**: `rating IN (1,2,3,4,5)` based on selected values
2. **Sentiments filter**: `sentiment IN ('positive','neutral','negative')` based on selected values
3. **Audio/Text filter**: 
   - If both includeAudio and includeText: no filter
   - If only includeAudio: `audio_url IS NOT NULL`
   - If only includeText: `audio_url IS NULL`
   - If neither: return empty results
4. **Flag filters**: 
   - `is_flagged = true` when isFlagged is true
   - `is_addressed = true` when isAddressed is true
   - Null values ignored (no filter applied)
5. **Search filter**: `transcription ILIKE '%term%' OR jsonb_exists_text(keywords, 'term')`
6. **QR filter**: Join with surveys table to filter by qr_code values

### Database Query Optimization
- Use Supabase query builder methods: `.in()`, `.or()`, `.ilike()`, `.is()`, `.not()`
- Combine filters efficiently to minimize query complexity
- Ensure proper indexing supports the most common filter combinations
- Test query performance with sample data

### Response API Alignment
Ensure the responses list API (`GET /api/responses`) supports identical filtering parameters and logic as the analytics API for consistency.

## Validation Requirements
- All filter parameters should be optional
- Invalid parameter values should be ignored or return appropriate errors
- Empty filter arrays should be treated as "no filter"
- Date range filters should be preserved and work with new filters
- Pagination should reset to page 1 when filters change

## Testing Considerations
- Test filter combinations to ensure they work together correctly
- Verify performance with larger datasets
- Test edge cases: empty results, invalid parameters, malformed queries
- Ensure RLS policies still work correctly with enhanced queries

## Dependencies
- Requires existing database schema with response management fields
- Depends on current Supabase client setup in `lib/supabase-server.ts`
- Uses existing type definitions in `src/types/index.ts`

## Out of Scope
- UI changes (will be handled in subsequent phases)
- Realtime analytics refresh (Phase 3)
- Authentication changes
- Client-side filtering logic changes
