## Feature: Realtime Dashboard, Analytics Wiring, Filters/Search, CSV Export, i18n (AR/FR)

### Context
Implement the next MVP-critical dashboard capabilities while skipping auth changes for now: realtime updates for responses, server-backed analytics metrics and charts, filter/search controls, CSV export of responses, and basic AR/FR i18n for UI strings. The data model and endpoints largely exist; this work wires them together and hardens the UX.

### Scope
- Realtime responses subscription by `business_id` to update the dashboard feed live.
- Server-side analytics endpoints to compute totals, averages, distributions, and trends.
- Client wiring for surveys list and recent responses with pagination and empty states.
- Filters: date range, rating, sentiment, and keyword search over `transcription` and `keywords`.
- CSV export endpoint returning filtered responses.
- i18n for AR/FR UI strings with RTL support.

### Files and Functions to Create/Change

1) Realtime
- `src/hooks/useRealtimeResponses.ts`: ensure channel subscribes on `responses` with filter `business_id=eq.${businessId}`; emit inserts to caller.
- `src/lib/supabase.ts`: verify client is configured for realtime; add helper `subscribeToResponses(businessId)` if needed.

2) Server analytics and responses APIs
- Create `src/app/api/analytics/route.ts` (if not present) with GET: `?business_id=...&from=...&to=...`.
  - Returns JSON: `{ totalResponses, averageRating, sentimentBreakdown, trends[], ratingDistribution, keywordCounts }`.
  - Use efficient SQL with existing indexes (`idx_responses_business_created`, `idx_responses_sentiment`).
- Create `src/app/api/responses/route.ts` with GET: `?business_id=...&page=1&limit=20&from=...&to=...&rating=...&sentiment=...&q=...`.
  - Returns JSON: `{ items: Response[], total, page, limit }`.
- Create `src/app/api/responses/export/route.ts` with GET: `?business_id=...&from=...&to=...&rating=...&sentiment=...&q=...&format=csv`.
  - Streams CSV with header; uses server-side filtering matching `/api/responses`.

3) Dashboard wiring
- `src/app/dashboard/page.tsx`:
  - On business load, fetch `/api/responses` and `/api/analytics` with default date range (last 30d); show loading/empty states.
  - Integrate realtime hook to prepend new items to `responses` list and recompute analytics minimally.
  - Add filter UI component and route params syncing.
- `src/components/dashboard/AnalyticsCards.tsx`:
  - Accept server data shape; remove client-only calculations.
- `src/components/dashboard/DashboardCharts.tsx`:
  - Expect `trends`, `ratingDistribution`, `keywordCounts` prepared by server.
- Add `src/components/dashboard/ResponseFilters.tsx` (if not already sufficient) to handle date/rating/sentiment/keyword and invoke parent handlers.

4) Lib utilities
- `src/lib/analytics.ts`:
  - Keep client fallback calculations, but prefer server-provided fields.
- `src/lib/response-filters.ts`:
  - Ensure helpers serialize filters into query params consistently for `/api/responses` and `/api/analytics`.

5) i18n
- Add `src/lib/i18n.ts` with simple dictionary-based i18n (`ar`, `fr`) and helper `t(key, lang)`.
- Wrap dashboard UI strings (`Overview`, `Business Profile`, `Create Survey`, cards, filters) to use `t` and apply RTL when `lang==='ar'`.
- Persist language selection (localStorage or query param) and default via `navigator.language`.

### Algorithms / Query Logic

1) Analytics (server)
- Inputs: `business_id`, optional `from`, `to` (defaults: last 30 days).
- Queries:
  - `totalResponses`: `SELECT COUNT(*) FROM responses WHERE business_id=$1 AND created_at BETWEEN $2 AND $3;`
  - `averageRating`: `SELECT COALESCE(AVG(rating),0) FROM responses WHERE business_id=$1 AND created_at BETWEEN $2 AND $3;`
  - `sentimentBreakdown`: `SELECT sentiment, COUNT(*) FROM responses WHERE business_id=$1 AND created_at BETWEEN $2 AND $3 GROUP BY sentiment;`
  - `trends` (daily): `SELECT DATE_TRUNC('day', created_at) as day, COUNT(*) as cnt FROM responses WHERE business_id=$1 AND created_at BETWEEN $2 AND $3 GROUP BY day ORDER BY day;`
  - `ratingDistribution`: `SELECT rating, COUNT(*) FROM responses WHERE business_id=$1 AND created_at BETWEEN $2 AND $3 GROUP BY rating;`
  - `keywordCounts`: For JSONB array `keywords`, `SELECT LOWER(elem)::text AS kw, COUNT(*) FROM (SELECT jsonb_array_elements_text(keywords) AS elem FROM responses WHERE business_id=$1 AND created_at BETWEEN $2 AND $3) s GROUP BY kw ORDER BY COUNT(*) DESC LIMIT 20;`

2) Responses listing (server)
- Inputs: `business_id`, `page`, `limit`, `from`, `to`, optional `rating`, `sentiment`, `q`.
- Build `WHERE` with parameter array; full-text-like search via `ILIKE` on `transcription` plus `q = ANY(keywords)` using `jsonb_exists_text` fallback: `(transcription ILIKE '%'||$q||'%' OR EXISTS (SELECT 1 FROM jsonb_array_elements_text(keywords) k WHERE k ILIKE '%'||$q||'%'))`.
- Pagination via `OFFSET (page-1)*limit LIMIT limit` and a separate `COUNT(*)` for total.

3) Realtime subscription
- Channel: `responses` table, `event='INSERT'`, filter: `business_id=eq.${businessId}`.
- On insert: prepend to list in memory; if filter controls are active, drop items not matching current filters; debounce recompute of derived analytics, or refetch `/api/analytics` for accuracy.

### Phases

Phase 1 – Data Layer & APIs
- Implement `/api/analytics`, `/api/responses`, `/api/responses/export` with validation (Zod), error handling, and RLS-compatible access (dev: permissive policies).

Phase 2 – UI Wiring
- Wire dashboard to new APIs, add filters/search, handle empty states, and integrate realtime updates.

Phase 3 – i18n
- Add dictionaries, apply to dashboard components, persist choice, handle RTL.

### Non-Goals
- Phone OTP auth replacement, admin panel, daily summaries cron.

### Validation
- Seed sample data (`database/setup-sample-data.sql`).
- Manual test: dashboard loads analytics and responses; realtime inserts appear within seconds; filters refine both list and analytics; CSV downloads with matching filters; language toggle switches labels and RTL.


